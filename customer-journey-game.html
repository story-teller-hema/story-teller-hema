<!DOCTYPE html>
<html lang="en">
<head>
<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-G6C2CXBS3J"></script>
<script>

      window.dataLayer = window.dataLayer || [];

      function gtag(){dataLayer.push(arguments);}

      gtag('js', new Date());

      gtag('config', 'G-G6C2CXBS3J');
</script>


<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Customer Journey Runner | Hema Kamineni</title>
<link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&family=Work+Sans:wght@400;600&display=swap" rel="stylesheet">
<style>

    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {

        font-family: 'Work Sans', sans-serif;

        background: linear-gradient(135deg, #0A0E27 0%, #0d1129 50%, #1a0e2e 100%);

        color: #E8EAF6;

        min-height: 100vh;

        padding: 40px 20px;

        position: relative;

    }

    body::before {

        content: '';

        position: fixed;

        top: 0;

        left: 0;

        width: 100%;

        height: 100%;

        background-image: 

            linear-gradient(rgba(255,255,255,0.02) 1px, transparent 1px),

            linear-gradient(90deg, rgba(255,255,255,0.02) 1px, transparent 1px);

        background-size: 50px 50px;

        z-index: 0;

        pointer-events: none;

    }

    .game-container {

        max-width: 900px;

        width: 100%;

        margin: 0 auto;

        position: relative;

        z-index: 1;

    }

    .breadcrumb {

        font-size: 14px;

        color: #9BA3C7;

        margin-bottom: 20px;

    }

    .breadcrumb a {

        color: #FF6B35;

        text-decoration: none;

    }

    .game-header {

        text-align: center;

        margin-bottom: 30px;

    }

    h1 {

        font-family: 'Press Start 2P', cursive;

        font-size: 24px;

        color: #00D9A5;

        margin-bottom: 10px;

        text-shadow: 3px 3px 0 rgba(0,217,165,0.3);

    }

    .subtitle {

        font-size: 14px;

        color: #9BA3C7;

    }

    .personal-best {

        margin-top: 24px;

        background: rgba(0,0,0,0.5);

        border: 3px solid #00D9A5;

        border-radius: 12px;

        padding: 16px 24px;

        box-shadow: 0 0 20px rgba(0,217,165,0.3), inset 0 0 20px rgba(0,217,165,0.1);

    }

    .best-label {

        font-family: 'Press Start 2P', cursive;

        font-size: 10px;

        color: #FFB020;

        text-align: center;

        margin-bottom: 12px;

        text-shadow: 0 0 10px rgba(255,176,32,0.5);

        animation: glow 2s ease-in-out infinite;

    }

    @keyframes glow {

        0%, 100% { opacity: 1; text-shadow: 0 0 10px rgba(255,176,32,0.5); }

        50% { opacity: 0.8; text-shadow: 0 0 20px rgba(255,176,32,0.8); }

    }

    .best-stats {

        display: flex;

        justify-content: center;

        align-items: center;

        gap: 16px;

    }

    .best-stat {

        display: flex;

        flex-direction: column;

        align-items: center;

    }

    .best-value {

        font-family: 'Press Start 2P', cursive;

        font-size: 16px;

        color: #00D9A5;

        text-shadow: 0 0 10px rgba(0,217,165,0.6);

        margin-bottom: 4px;

    }

    .best-value.new-record {

        animation: recordFlash 0.5s ease-in-out 3;

    }

    @keyframes recordFlash {

        0%, 100% { color: #00D9A5; transform: scale(1); }

        50% { color: #FFB020; transform: scale(1.2); }

    }

    .best-metric {

        font-family: 'Press Start 2P', cursive;

        font-size: 7px;

        color: #9BA3C7;

        text-transform: uppercase;

    }

    .best-divider {

        font-family: 'Press Start 2P', cursive;

        font-size: 16px;

        color: #9BA3C7;

    }

    .global-leaderboard {

        margin-top: 24px;

        background: rgba(0,0,0,0.5);

        border: 3px solid #FFB020;

        border-radius: 12px;

        padding: 20px;

        box-shadow: 0 0 20px rgba(255,176,32,0.3), inset 0 0 20px rgba(255,176,32,0.1);

    }

    .leaderboard-title {

        font-family: 'Press Start 2P', cursive;

        font-size: 11px;

        color: #FFB020;

        text-align: center;

        margin-bottom: 16px;

        text-shadow: 0 0 10px rgba(255,176,32,0.5);

    }

    .leaderboard-list {

        margin-bottom: 16px;

    }

    .leaderboard-entry {

        display: flex;

        justify-content: space-between;

        align-items: center;

        padding: 8px 12px;

        background: rgba(255,255,255,0.03);

        border-radius: 6px;

        margin-bottom: 6px;

        font-family: 'Press Start 2P', cursive;

        font-size: 9px;

    }

    .leaderboard-entry.rank-1 {

        background: rgba(255,215,0,0.1);

        border: 1px solid rgba(255,215,0,0.3);

    }

    .leaderboard-entry.rank-2 {

        background: rgba(192,192,192,0.1);

        border: 1px solid rgba(192,192,192,0.3);

    }

    .leaderboard-entry.rank-3 {

        background: rgba(205,127,50,0.1);

        border: 1px solid rgba(205,127,50,0.3);

    }

    .entry-rank {

        color: #FFB020;

        min-width: 20px;

    }

    .entry-name {

        flex: 1;

        color: #E8EAF6;

        margin-left: 12px;

    }

    .entry-score {

        color: #00D9A5;

        margin-right: 8px;

    }

    .entry-cvr {

        color: #9BA3C7;

    }

    .loading-text {

        font-family: 'Press Start 2P', cursive;

        font-size: 8px;

        color: #9BA3C7;

        text-align: center;

        padding: 20px;

    }

    .your-rank {

        font-family: 'Press Start 2P', cursive;

        font-size: 9px;

        color: #00D9A5;

        text-align: center;

        padding: 12px;

        background: rgba(0,217,165,0.1);

        border-radius: 6px;

        margin-bottom: 12px;

    }

    .leaderboard-disclaimer {

        font-family: 'Work Sans', sans-serif;

        font-size: 11px;

        color: #9BA3C7;

        text-align: center;

        font-style: italic;

        line-height: 1.4;

    }

    .game-canvas-wrapper {

        position: relative;

        background: #1a0e2e;

        border: 4px solid #00D9A5;

        border-radius: 12px;

        overflow: hidden;

        box-shadow: 0 0 40px rgba(0,217,165,0.3);

        min-height: 500px;

    }

    canvas {

        display: block;

        width: 100%;

        height: auto;

    }

    .game-stats {

        display: grid;

        grid-template-columns: repeat(3, 1fr);

        gap: 16px;

        margin-top: 20px;

        font-family: 'Press Start 2P', cursive;

        font-size: 12px;

    }

    .stat {

        background: rgba(255,255,255,0.05);

        border: 2px solid rgba(255,255,255,0.1);

        border-radius: 8px;

        padding: 12px;

        text-align: center;

    }

    .stat-label {

        color: #9BA3C7;

        font-size: 8px;

        margin-bottom: 8px;

    }

    .stat-value {

        color: #00D9A5;

        font-size: 16px;

    }

    .controls {

        margin-top: 20px;

        text-align: center;

        font-size: 12px;

        color: #9BA3C7;

    }

    .controls strong {

        color: #FF6B35;

    }

    .mobile-controls {

        display: none;

        grid-template-columns: 1fr 1fr;

        gap: 16px;

        margin-top: 20px;

    }

    .control-btn {

        font-family: 'Press Start 2P', cursive;

        font-size: 12px;

        padding: 20px;

        background: rgba(0,217,165,0.2);

        border: 2px solid #00D9A5;

        border-radius: 12px;

        color: #00D9A5;

        cursor: pointer;

        transition: all 0.2s;

        user-select: none;

        -webkit-tap-highlight-color: transparent;

    }

    .control-btn:active {

        background: rgba(0,217,165,0.4);

        transform: scale(0.95);

    }

    @media (max-width: 768px) {

        .controls {

            display: none;

        }

        .mobile-controls {

            display: grid;

        }

    }

    #startScreen, #gameOverScreen {

        position: absolute;

        top: 0;

        left: 0;

        width: 100%;

        height: 100%;

        background: rgba(10, 14, 39, 0.95);

        display: flex;

        flex-direction: column;

        justify-content: center;

        align-items: center;

        text-align: center;

        padding: 20px;

        overflow-y: auto;

        -webkit-overflow-scrolling: touch;

    }

    .screen-title {

        font-family: 'Press Start 2P', cursive;

        font-size: 20px;

        color: #00D9A5;

        margin-bottom: 30px;

        line-height: 1.6;

    }

    .instructions {

        font-size: 14px;

        color: #E8EAF6;

        margin-bottom: 30px;

        line-height: 1.8;

        max-width: 500px;

    }

    .start-button {

        font-family: 'Press Start 2P', cursive;

        font-size: 14px;

        padding: 16px 32px;

        background: #00D9A5;

        color: #0A0E27;

        border: none;

        border-radius: 8px;

        cursor: pointer;

        transition: all 0.3s;

    }

    .start-button:hover {

        background: #00f5bc;

        transform: scale(1.05);

    }

    .power-ups-list {

        text-align: left;

        margin: 20px 0;

        font-size: 12px;

    }

    .power-ups-list li {

        margin: 8px 0;

        color: #9BA3C7;

    }

    #gameOverScreen {

        display: none;

    }

    .final-score {

        font-size: 32px;

        color: #FF6B35;

        margin: 20px 0;

    }

    @media (max-width: 768px) {

        h1 {

            font-size: 16px;

            line-height: 1.4;

        }

        .subtitle {

            font-size: 12px;

        }

        .personal-best {

            padding: 12px 16px;

            margin-top: 16px;

        }

        .best-label {

            font-size: 8px;

            margin-bottom: 8px;

        }

        .best-stats {

            gap: 8px;

        }

        .best-value {

            font-size: 12px;

        }

        .best-metric {

            font-size: 6px;

        }

        .best-divider {

            font-size: 12px;

        }

        .global-leaderboard {

            padding: 16px 12px;

            margin-top: 16px;

        }

        .leaderboard-title {

            font-size: 9px;

            margin-bottom: 12px;

        }

        .leaderboard-entry {

            font-size: 7px;

            padding: 6px 8px;

        }

        .your-rank {

            font-size: 8px;

            padding: 10px;

        }

        .leaderboard-disclaimer {

            font-size: 10px;

        }

        .game-canvas-wrapper {

            border-width: 3px;

            min-height: 60vh;

        }

        canvas {

            touch-action: none;

            min-height: 60vh;

        }

        .game-stats {

            grid-template-columns: repeat(3, 1fr);

            gap: 8px;

            font-size: 10px;

        }

        .stat {

            padding: 8px;

        }

        .stat-value {

            font-size: 12px;

        }

        .stat-label {

            font-size: 7px;

        }

        .controls {

            display: none;

        }

        .mobile-controls {

            display: grid;

        }

        .control-btn {

            font-size: 10px;

            padding: 16px;

        }

        .game-container {

            padding: 0;

        }

        body {

            padding: 20px 10px;

        }

        #startScreen, #gameOverScreen {

            padding: 15px;

            justify-content: flex-start;

            padding-top: 30px;

        }

        .screen-title {

            font-size: 14px;

            margin-bottom: 15px;

            line-height: 1.4;

        }

        .instructions {

            font-size: 12px;

            margin-bottom: 15px;

            line-height: 1.5;

        }

        .power-ups-list {

            margin: 12px 0;

            font-size: 11px;

        }

        .power-ups-list li {

            margin: 4px 0;

        }

        .start-button {

            font-size: 11px;

            padding: 12px 24px;

        }

    }
</style>
<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>


</head>
<body>
<div class="game-container">
<div class="breadcrumb">
<a href="index.html">Home</a> / <a href="interactive-sims.html">Interactive Sims</a> / Customer Journey Runner
</div>


<div class="game-header">
<h1>CUSTOMER JOURNEY RUNNER</h1>
<p class="subtitle">Guide customers from awareness to conversion</p>
<div class="personal-best">
<div class="best-label">üèÜ YOUR PERSONAL BEST üèÜ</div>
<div class="best-stats">
<div class="best-stat">
<span class="best-value" id="bestScore">---</span>
<span class="best-metric">POINTS</span>
</div>
<div class="best-divider">|</div>
<div class="best-stat">
<span class="best-value" id="bestConvRate">---%</span>
<span class="best-metric">CVR</span>
</div>
<div class="best-divider">|</div>
<div class="best-stat">
<span class="best-value" id="bestDistance">---m</span>
<span class="best-metric">DISTANCE</span>
</div>
</div>
</div>
<div class="global-leaderboard">
<div class="leaderboard-title">üèÜ GLOBAL LEADERBOARD üèÜ</div>
<div class="leaderboard-list" id="leaderboardList">
<div class="loading-text">Loading top scores...</div>
</div>
<div class="your-rank" id="yourRank" style="display:none;">

                Your Rank: <span id="rankNumber">--</span>
</div>
<div class="leaderboard-disclaimer">

                ‚è±Ô∏è High scores save every 60 seconds to prevent spam. Keep playing!
</div>
</div>
</div>
<div class="game-canvas-wrapper">
<canvas id="gameCanvas" width="800" height="400"></canvas>
<div id="startScreen">
<div class="screen-title">READY TO RUN?</div>
<div class="instructions">

                Guide customers through their journey from awareness to purchase. <strong>Jump over</strong> ground obstacles (üö´ üè¢) and <strong>duck under</strong> flying obstacles (üç™ üíî). Collect power-ups to improve attribution and conversion rates!
</div>
<div class="power-ups-list">
<strong style="color: #00D9A5;">Power-Ups:</strong>
<ul style="list-style: none;">
<li>üìä Multi-Touch Attribution</li>
<li>üîó CDP Integration</li>
<li>üéØ Identity Resolution</li>
<li>‚ö° Real-Time Data</li>
</ul>
</div>
<button class="start-button" onclick="startGame()">START GAME</button>
</div>
<div id="gameOverScreen">
<div class="screen-title">GAME OVER!</div>
<div class="final-score" id="finalScore">Score: 0</div>
<div class="instructions" id="conversionMessage"></div>
<button class="start-button" onclick="restartGame()">PLAY AGAIN</button>
</div>
</div>
<div class="game-stats">
<div class="stat">
<div class="stat-label">SCORE</div>
<div class="stat-value" id="score">0</div>
</div>
<div class="stat">
<div class="stat-label">CONVERSIONS</div>
<div class="stat-value" id="conversions">0</div>
</div>
<div class="stat">
<div class="stat-label">JOURNEY</div>
<div class="stat-value" id="distance">0m</div>
</div>
</div>
<div class="controls">
<strong>SPACE</strong> to jump  ‚Ä¢  <strong>‚Üì</strong> to duck  ‚Ä¢  Dodge obstacles, collect power-ups!
</div>
<div class="mobile-controls">
<button class="control-btn" id="jumpBtn">JUMP</button>
<button class="control-btn" id="duckBtn">DUCK</button>
</div>
</div>
<script>

    // Personal Best Tracking with localStorage

    function loadPersonalBest() {

        const bestScore = localStorage.getItem('cjr_best_score') || '---';

        const bestConvRate = localStorage.getItem('cjr_best_conv_rate') || '---';

        const bestDistance = localStorage.getItem('cjr_best_distance') || '---';

        document.getElementById('bestScore').textContent = bestScore === '---' ? '---' : bestScore;

        document.getElementById('bestConvRate').textContent = bestConvRate === '---' ? '---' : bestConvRate + '%';

        document.getElementById('bestDistance').textContent = bestDistance === '---' ? '---' : bestDistance + 'm';

    }

    function checkAndSavePersonalBest(score, convRate, distance) {

        let newRecord = false;

        const currentBest = parseInt(localStorage.getItem('cjr_best_score')) || 0;

        if (score > currentBest) {

            localStorage.setItem('cjr_best_score', score);

            localStorage.setItem('cjr_best_conv_rate', convRate);

            localStorage.setItem('cjr_best_distance', distance);

            newRecord = true;

            // Update display with animation

            document.getElementById('bestScore').textContent = score;

            document.getElementById('bestScore').classList.add('new-record');

            document.getElementById('bestConvRate').textContent = convRate + '%';

            document.getElementById('bestConvRate').classList.add('new-record');

            document.getElementById('bestDistance').textContent = distance + 'm';

            document.getElementById('bestDistance').classList.add('new-record');

            // Remove animation class after it completes

            setTimeout(() => {

                document.querySelectorAll('.best-value').forEach(el => {

                    el.classList.remove('new-record');

                });

            }, 1500);

        }

        return newRecord;

    }

    // Firebase Configuration and Initialization

    const firebaseConfig = {

        apiKey: "AIzaSyAdLN5-HSSMtYEaA6qO10Y08IGqdN3EMhY",

        authDomain: "customer-journey-leaderboard.firebaseapp.com",

        databaseURL: "https://customer-journey-leaderboard-default-rtdb.firebaseio.com",

        projectId: "customer-journey-leaderboard",

        storageBucket: "customer-journey-leaderboard.firebasestorage.app",

        messagingSenderId: "1071067262770",

        appId: "1:1071067262770:web:8ce0178dea23151f67b12b"

    };

    // Initialize Firebase

    firebase.initializeApp(firebaseConfig);

    const database = firebase.database();

    // Rate limiting for leaderboard submissions

    let lastSubmissionTime = 0;

    const SUBMISSION_COOLDOWN = 60000; // 60 seconds

    // Generate anonymous player ID (stored in localStorage)

    function getPlayerId() {

        let playerId = localStorage.getItem('cjr_player_id');

        if (!playerId) {

            playerId = 'PLAYER_' + Math.random().toString(36).substr(2, 6).toUpperCase();

            localStorage.setItem('cjr_player_id', playerId);

        }

        return playerId;

    }

    // Validate score to prevent cheating

    function isValidScore(score, convRate, distance) {

        if (score < 0 || score > 5000) return false;

        if (convRate < 0 || convRate > 100) return false;

        if (distance < 0 || distance > 10000) return false;

        // Score should roughly match distance traveled

        const minExpectedScore = (distance / 50) * 5;

        const maxExpectedScore = (distance / 50) * 150;

        if (score < minExpectedScore * 0.5 || score > maxExpectedScore * 2) {

            return false;

        }

        return true;

    }

    // Save score to Firebase leaderboard

    function saveToLeaderboard(score, convRate, distance) {

        const now = Date.now();

        // Check rate limiting

        if (now - lastSubmissionTime < SUBMISSION_COOLDOWN) {

            console.log('Rate limited - wait ' + Math.ceil((SUBMISSION_COOLDOWN - (now - lastSubmissionTime)) / 1000) + ' seconds');

            return;

        }

        // Validate score

        if (!isValidScore(score, convRate, distance)) {

            console.log('Invalid score detected');

            return;

        }

        const playerId = getPlayerId();

        const leaderboardRef = database.ref('leaderboard');

        leaderboardRef.push({

            playerId: playerId,

            score: score,

            conversionRate: parseFloat(convRate),

            distance: distance,

            timestamp: now

        }).then(() => {

            lastSubmissionTime = now;

            console.log('Score saved to leaderboard');

            loadLeaderboard();

        }).catch((error) => {

            console.error('Error saving score:', error);

        });

    }

    // Load top 5 scores from Firebase

    function loadLeaderboard() {

        const leaderboardRef = database.ref('leaderboard');

        leaderboardRef

            .orderByChild('score')

            .limitToLast(5)

            .once('value')

            .then((snapshot) => {

                const scores = [];

                snapshot.forEach((child) => {

                    scores.push(child.val());

                });

                displayLeaderboard(scores.reverse());

                calculateYourRank(scores);

            })

            .catch((error) => {

                console.error('Error loading leaderboard:', error);

                document.getElementById('leaderboardList').innerHTML = '<div class="loading-text">Failed to load scores</div>';

            });

    }

    // Display leaderboard entries

    function displayLeaderboard(scores) {

        const listEl = document.getElementById('leaderboardList');

        if (scores.length === 0) {

            listEl.innerHTML = '<div class="loading-text">No scores yet. Be the first!</div>';

            return;

        }

        let html = '';

        scores.forEach((entry, index) => {

            const rank = index + 1;

            const rankClass = rank <= 3 ? `rank-${rank}` : '';

            html += `
<div class="leaderboard-entry ${rankClass}">
<span class="entry-rank">${rank}.</span>
<span class="entry-name">${entry.playerId}</span>
<span class="entry-score">${entry.score}</span>
<span class="entry-cvr">${entry.conversionRate}%</span>
</div>

            `;

        });

        listEl.innerHTML = html;

    }

    // Calculate and display player's rank

    function calculateYourRank(topScores) {

        const playerId = getPlayerId();

        const bestScore = parseInt(localStorage.getItem('cjr_best_score')) || 0;

        if (bestScore === 0) {

            document.getElementById('yourRank').style.display = 'none';

            return;

        }

        // Get all scores to calculate rank

        database.ref('leaderboard')

            .orderByChild('score')

            .once('value')

            .then((snapshot) => {

                const allScores = [];

                snapshot.forEach((child) => {

                    allScores.push(child.val().score);

                });

                allScores.sort((a, b) => b - a);

                const rank = allScores.findIndex(s => s <= bestScore) + 1;

                if (rank > 0) {

                    document.getElementById('rankNumber').textContent = '#' + rank;

                    document.getElementById('yourRank').style.display = 'block';

                }

            });

    }

    // Load personal best and leaderboard on page load

    window.addEventListener('load', () => {

        loadPersonalBest();

        loadLeaderboard();

    });

    const canvas = document.getElementById('gameCanvas');

    const ctx = canvas.getContext('2d');

    // Make canvas responsive

    function resizeCanvas() {

        const container = canvas.parentElement;

        const containerWidth = container.clientWidth;

        // Set display size (css pixels)

        canvas.style.width = '100%';

        canvas.style.height = 'auto';

        // Determine aspect ratio based on screen size

        // Mobile gets much taller canvas for better visibility

        const isMobile = window.innerWidth <= 768;

        const aspectRatio = isMobile ? 0.8 : 2; // Mobile: almost square, Desktop: wide

        // Set actual size in memory (scaled to account for extra pixel density)

        const scale = window.devicePixelRatio || 1;

        canvas.width = Math.floor(containerWidth * scale);

        canvas.height = Math.floor((containerWidth / aspectRatio) * scale);

        // Set substantial minimum height on mobile - 60% of viewport height

        if (isMobile) {

            const minHeight = window.innerHeight * 0.6 * scale;

            if (canvas.height < minHeight) {

                canvas.height = minHeight;

            }

        }

        // Normalize coordinate system

        ctx.scale(scale, scale);

    }

    // Initial setup and handle window resize

    resizeCanvas();

    window.addEventListener('resize', resizeCanvas);

    let gameRunning = false;

    let score = 0;

    let conversions = 0;

    let distance = 0;

    let gameSpeed = 4;  // Reduced from 5 to 4 - slower starting speed

    let gravity = 0.8;

    // Get canvas logical size for game coordinates

    function getCanvasSize() {

        const rect = canvas.getBoundingClientRect();

        return { width: rect.width, height: rect.height };

    }

    // Player (customer)

    const player = {

        x: 100,

        y: 300,

        width: 40,

        height: 40,

        velocityY: 0,

        jumping: false,

        ducking: false

    };

    // Arrays for game objects

    let obstacles = [];

    let powerups = [];

    let particles = [];

    // Obstacle types

    const obstacleTypes = [

        { name: 'Ad Blocker', color: '#FF6B6B', emoji: 'üö´', flying: false },

        { name: 'Cookie Wall', color: '#FFB020', emoji: 'üç™', flying: true },  // Flying - need to duck

        { name: 'Platform Silo', color: '#9D4EDD', emoji: 'üè¢', flying: false },

        { name: 'Data Loss', color: '#FF6B35', emoji: 'üíî', flying: true }  // Flying - need to duck

    ];

    // Power-up types

    const powerupTypes = [

        { name: 'Multi-Touch', emoji: 'üìä', color: '#00D9A5' },

        { name: 'CDP', emoji: 'üîó', color: '#9D4EDD' },

        { name: 'Identity', emoji: 'üéØ', color: '#FF6B35' },

        { name: 'Real-Time', emoji: '‚ö°', color: '#FFB020' }

    ];

    // Keyboard controls

    const keys = {};

    document.addEventListener('keydown', (e) => {

        keys[e.key] = true;

        if (e.key === ' ' && gameRunning) {

            e.preventDefault();

            jump();

        }

    });

    document.addEventListener('keyup', (e) => {

        keys[e.key] = false;

        if (e.key === 'ArrowDown') {

            player.ducking = false;

        }

    });

    // Mobile touch controls

    const jumpBtn = document.getElementById('jumpBtn');

    const duckBtn = document.getElementById('duckBtn');

    // Prevent default touch behaviors

    jumpBtn.addEventListener('touchstart', (e) => {

        e.preventDefault();

        e.stopPropagation();

        if (gameRunning) jump();

    }, { passive: false });

    duckBtn.addEventListener('touchstart', (e) => {

        e.preventDefault();

        e.stopPropagation();

        if (gameRunning) {

            player.ducking = true;

            player.height = 25;

        }

    }, { passive: false });

    duckBtn.addEventListener('touchend', (e) => {

        e.preventDefault();

        e.stopPropagation();

        player.ducking = false;

        player.height = 40;

    }, { passive: false });

    duckBtn.addEventListener('touchcancel', (e) => {

        e.preventDefault();

        player.ducking = false;

        player.height = 40;

    }, { passive: false });

    // Also support mouse for desktop testing

    jumpBtn.addEventListener('click', (e) => {

        e.preventDefault();

        if (gameRunning) jump();

    });

    duckBtn.addEventListener('mousedown', (e) => {

        e.preventDefault();

        if (gameRunning) {

            player.ducking = true;

            player.height = 25;

        }

    });

    duckBtn.addEventListener('mouseup', (e) => {

        e.preventDefault();

        player.ducking = false;

        player.height = 40;

    });

    function jump() {

        if (!player.jumping) {

            player.velocityY = -15;

            player.jumping = true;

        }

    }

    function startGame() {

        document.getElementById('startScreen').style.display = 'none';

        gameRunning = true;

        score = 0;

        conversions = 0;

        distance = 0;

        gameSpeed = 4;  // Reduced from 5 to 4

        obstacles = [];

        powerups = [];

        player.y = 300;

        player.velocityY = 0;

        player.jumping = false;

        // GA4 Event: Game Started

        if (typeof gtag !== 'undefined') {

            gtag('event', 'game_start', {

                game_name: 'customer_journey_runner',

                event_category: 'game_interaction'

            });

        }

        gameLoop();

    }

    function restartGame() {

        document.getElementById('gameOverScreen').style.display = 'none';

        startGame();

    }

    function spawnObstacle() {

        if (Math.random() < 0.01) {  // Reduced from 0.02 to 0.01 - half as many obstacles

            const canvasSize = getCanvasSize();

            const type = obstacleTypes[Math.floor(Math.random() * obstacleTypes.length)];

            // Flying obstacles are higher up (need to duck), ground obstacles are at ground level (need to jump)

            const yPosition = type.flying ? 230 : 300;  // Flying at 230, ground at 300

            const height = type.flying ? 40 : 50;

            obstacles.push({

                x: canvasSize.width,

                y: yPosition,

                width: 40,

                height: height,

                type: type

            });

        }

    }

    function spawnPowerup() {

        if (Math.random() < 0.012) {  // Increased from 0.008 to 0.012 - more powerups

            const canvasSize = getCanvasSize();

            const type = powerupTypes[Math.floor(Math.random() * powerupTypes.length)];

            powerups.push({

                x: canvasSize.width,

                y: 150 + Math.random() * 100,

                width: 30,

                height: 30,

                type: type

            });

        }

    }

    function createParticles(x, y, color) {

        for (let i = 0; i < 10; i++) {

            particles.push({

                x: x,

                y: y,

                vx: (Math.random() - 0.5) * 8,

                vy: (Math.random() - 0.5) * 8,

                life: 30,

                color: color

            });

        }

    }

    function checkCollisions() {

        // Check obstacle collisions

        for (let obstacle of obstacles) {

            if (player.x < obstacle.x + obstacle.width &&

                player.x + player.width > obstacle.x &&

                player.y < obstacle.y + obstacle.height &&

                player.y + player.height > obstacle.y) {

                gameOver();

                return;

            }

        }

        // Check powerup collection

        for (let i = powerups.length - 1; i >= 0; i--) {

            const powerup = powerups[i];

            if (player.x < powerup.x + powerup.width &&

                player.x + player.width > powerup.x &&

                player.y < powerup.y + powerup.height &&

                player.y + player.height > powerup.y) {

                score += 100;

                conversions += 1;

                createParticles(powerup.x, powerup.y, powerup.type.color);

                // GA4 Event: Power-up collected (optional - for detailed analysis)

                if (typeof gtag !== 'undefined') {

                    gtag('event', 'powerup_collected', {

                        game_name: 'customer_journey_runner',

                        powerup_type: powerup.type.name,

                        current_conversions: conversions,

                        current_score: score

                    });

                }

                powerups.splice(i, 1);

            }

        }

    }

    function gameOver() {

        gameRunning = false;

        document.getElementById('finalScore').textContent = `Score: ${score}`;

        const convRate = conversions > 0 ? Math.min(100, (conversions / (distance / 50)).toFixed(1)) : 0;

        // Check if new personal best

        const isNewRecord = checkAndSavePersonalBest(score, convRate, Math.floor(distance));

        let message = `You converted ${conversions} customers over ${Math.floor(distance)}m journey. Conversion rate: ${convRate}%`;

        if (isNewRecord) {

            message += `\n\nüèÜ NEW PERSONAL BEST! üèÜ`;

        }

        document.getElementById('conversionMessage').textContent = message;

        // Save to Firebase leaderboard (with rate limiting)

        saveToLeaderboard(score, convRate, Math.floor(distance));

        // GA4 Event: Game Over with metrics

        if (typeof gtag !== 'undefined') {

            gtag('event', 'game_over', {

                game_name: 'customer_journey_runner',

                event_category: 'game_interaction',

                score: score,

                conversions: conversions,

                distance: Math.floor(distance),

                conversion_rate: parseFloat(convRate),

                value: score,

                is_new_record: isNewRecord

            });

        }

        document.getElementById('gameOverScreen').style.display = 'flex';

    }

    function update() {

        // Player physics

        if (keys['ArrowDown'] && player.y >= 300) {

            player.ducking = true;

            player.height = 25;

        } else {

            player.ducking = false;

            player.height = 40;

        }

        player.velocityY += gravity;

        player.y += player.velocityY;

        if (player.y >= 300) {

            player.y = 300;

            player.jumping = false;

            player.velocityY = 0;

        }

        // Update obstacles

        spawnObstacle();

        for (let i = obstacles.length - 1; i >= 0; i--) {

            obstacles[i].x -= gameSpeed;

            if (obstacles[i].x + obstacles[i].width < 0) {

                obstacles.splice(i, 1);

                score += 10;

            }

        }

        // Update powerups

        spawnPowerup();

        for (let i = powerups.length - 1; i >= 0; i--) {

            powerups[i].x -= gameSpeed;

            powerups[i].y += Math.sin(Date.now() / 200 + i) * 0.5;

            if (powerups[i].x + powerups[i].width < 0) {

                powerups.splice(i, 1);

            }

        }

        // Update particles

        for (let i = particles.length - 1; i >= 0; i--) {

            const p = particles[i];

            p.x += p.vx;

            p.y += p.vy;

            p.life--;

            if (p.life <= 0) {

                particles.splice(i, 1);

            }

        }

        // Update stats

        distance += gameSpeed / 10;

        gameSpeed += 0.0005;  // Reduced from 0.001 - game speeds up half as fast

        document.getElementById('score').textContent = score;

        document.getElementById('conversions').textContent = conversions;

        document.getElementById('distance').textContent = Math.floor(distance) + 'm';

        checkCollisions();

    }

    function draw() {

        const canvasSize = getCanvasSize();

        // Clear canvas

        ctx.fillStyle = '#1a0e2e';

        ctx.fillRect(0, 0, canvasSize.width, canvasSize.height);

        // Draw ground

        ctx.fillStyle = 'rgba(0,217,165,0.2)';

        ctx.fillRect(0, 340, canvasSize.width, 60);

        ctx.strokeStyle = '#00D9A5';

        ctx.lineWidth = 2;

        ctx.beginPath();

        ctx.moveTo(0, 340);

        ctx.lineTo(canvasSize.width, 340);

        ctx.stroke();

        // Draw player

        ctx.fillStyle = '#00D9A5';

        ctx.fillRect(player.x, player.y, player.width, player.height);

        ctx.font = '30px Arial';

        ctx.fillText('üë§', player.x + 5, player.y + 30);

        // Draw obstacles

        for (let obstacle of obstacles) {

            ctx.fillStyle = obstacle.type.color;

            ctx.fillRect(obstacle.x, obstacle.y, obstacle.width, obstacle.height);

            ctx.font = '35px Arial';

            ctx.fillText(obstacle.type.emoji, obstacle.x + 2, obstacle.y + 35);

        }

        // Draw powerups

        for (let powerup of powerups) {

            ctx.fillStyle = powerup.type.color;

            ctx.globalAlpha = 0.3;

            ctx.fillRect(powerup.x, powerup.y, powerup.width, powerup.height);

            ctx.globalAlpha = 1;

            ctx.font = '25px Arial';

            ctx.fillText(powerup.type.emoji, powerup.x, powerup.y + 23);

        }

        // Draw particles

        for (let p of particles) {

            ctx.fillStyle = p.color;

            ctx.globalAlpha = p.life / 30;

            ctx.fillRect(p.x, p.y, 4, 4);

            ctx.globalAlpha = 1;

        }

    }

    function gameLoop() {

        if (!gameRunning) return;

        update();

        draw();

        requestAnimationFrame(gameLoop);

    }
</script>


</body>
</html>
 
